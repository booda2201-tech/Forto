<section class="contt">
  <div class="new-reservation-container">
    <div class="header">
      <h2 class="text-center mb-4 fw-bold text-dark">
        <i class="bi bi-calendar-plus text-orange"></i> حجز جديد
      </h2>
      <p>أدخل بيانات العميل وتفاصيل الخدمة المطلوبة</p>
    </div>

    <form [formGroup]="customerForm" (ngSubmit)="onSubmit()" class="reservation-form">
      <div class="form-section">
        <h3><i class="bi bi-people-fill mx-1"></i> بيانات العميل والسيارة</h3>
        <div class="row">
          <div class="form-group">
            <label><i class="bi bi-person mx-1"></i> اسم العميل
              <span *ngIf="currentClientIsPremium" class="badge bg-warning text-dark ms-2">عميل مميز</span>
            </label>
            <input type="text" formControlName="name" placeholder="ادخل اسم العميل" />
          </div>
            <div class="form-group">
              <label><i class="bi bi-telephone mx-1"></i> رقم الهاتف
                <span class="spinner-border spinner-border-sm text-primary ms-2" *ngIf="isLookingUpClient" role="status">
                  <span class="visually-hidden">Loading...</span>
                </span>
              </label>
              <input
                type="text"
                formControlName="phone"
                placeholder="+966 5x xxx xxxx"
                class="text-end"
                (keypress)="onlyNumbers($event)"
                inputmode="numeric"
              />
            </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label><i class="bi bi-car-front mx-1"></i> نوع السيارة </label>
            <input type="text" formControlName="carType" placeholder="مثال: تويوتا كامري 2023" />
          </div>
          <div class="form-group">
            <label><i class="bi bi-map mx-1"></i> رقم اللوحة </label>
            <input type="text" formControlName="carNumber" placeholder="ب ص ج 1234" />
          </div>
          <div class="form-group mt-1">
            <label><i class="bi bi-car-front mx-1"></i> فئة السيارة </label>
              <select class="form-select custom-select" formControlName="carCategory">
                <option [ngValue]="null" disabled>اختر فئة السيارة</option>
                <option *ngFor="let cat of carCategories" [ngValue]="cat.id" class="text-dark">
                  {{ cat.nameAr }}
                </option>
              </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3><i class="bi bi-info-circle-fill mx-1"></i> تفاصيل الخدمة</h3>
        <div class="row">
          <div class="form-group col-md-8">
            <label><i class="bi bi-calendar-date mx-1"></i> تاريخ الحجز </label>
            <input type="date" formControlName="appointmentDate" (change)="loadAvailableSlots()" />
          </div>
          <div class="form-group col-md-4">
            <label><i class="bi bi-clock mx-1"></i> الوقت

              <small class="text-muted d-inline-block mb-2 mx-1" *ngIf="isSlotsLoading">
                جاري تحميل المواعيد...
              </small>

            </label>

            <!-- Dropdown -->
            <select class="form-select" [(ngModel)]="selectedSlotHour" [ngModelOptions]="{ standalone: true }"
              [disabled]="availableSlots.length === 0"
>
              <option [ngValue]="null" disabled selected>اختر وقت</option>

              <option *ngFor="let slot of availableSlots" [ngValue]="slot.hour" [disabled]="slot.available === 0">
                {{ slot.hour }} - (متاح: {{ slot.available }})
              </option>
            </select>

            <!-- No slots message -->
            <small class="text-danger d-block mt-2" *ngIf="
                !isSlotsLoading &&
                selectedServices.length > 0 &&
                customerForm.value.appointmentDate &&
                (!availableSlots || availableSlots.length === 0)
              ">
              لا توجد مواعيد متاحة لهذا اليوم.
            </small>
          </div>
        </div>

        <div class="form-group">
          <label class="mb-3"><i class="bi bi-wrench mx-2"></i> اختر الخدمة
          </label>
          <div class="services-container">
            <div class="service-card" *ngFor="let service of services" [class.selected]="isServiceSelected(service)">
              <input type="checkbox" [id]="'service-' + service.id" (change)="toggleService(service, $event)"
                [checked]="isServiceSelected(service)" />
              <label [for]="'service-' + service.id" class="service-content">
                <span class="service-name">{{ service.name }}</span>
                <span class="service-price">{{ service.price }} ج.م</span>
                <div class="check-icon" *ngIf="isServiceSelected(service)">
                  <i class="bi bi-check-circle-fill"></i>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="form-footer">
        <div class="total-price">
          <span>الإجمالي المتوقع: </span>
          <strong>{{ totalPrice }} ج.م</strong>
        </div>
        <div class="actions">
          <button type="button" class="btn-cancel" (click)="customerForm.reset()">
            إلغاء
          </button>
          <button type="submit" class="btn-save">تأكيد الحجز</button>
        </div>
      </div>
    </form>

  </div>
</section>

<!-- Car Selection Modal - overlay نتحكم فيه بالكامل (بدون Bootstrap Modal JS) -->
<div *ngIf="showCarSelectionModal" class="car-selection-overlay" dir="rtl" role="dialog" aria-modal="true">
  <div class="car-selection-backdrop" (click)="closeCarSelectionModal()"></div>
  <div class="car-selection-dialog" (click)="$event.stopPropagation()">
    <div class="car-selection-content border-0 shadow-lg rounded-4">

      <div class="d-flex justify-content-between align-items-center px-4 pt-4 pb-2">
        <h5 class="fw-bold mb-0">اختر السيارة</h5>
        <button type="button" class="btn-close ms-0 me-auto" (click)="closeCarSelectionModal()"></button>
      </div>

      <div class="px-4 pb-4">
        <div *ngIf="selectedClient">
          <div class="alert alert-info mb-3">
            <strong>العميل:</strong> {{ selectedClient.fullName }}
            <span *ngIf="selectedClient.isPremiumCustomer" class="badge bg-warning text-dark ms-2">عميل مميز</span>
            <br>
            <strong>الهاتف:</strong> {{ selectedClient.phoneNumber }}
          </div>
        </div>

        <div *ngIf="foundClients.length > 1 && !selectedClient" class="alert alert-warning mb-3">
          تم العثور على {{ foundClients.length }} عملاء بهذا الرقم. اختر السيارة:
        </div>

        <div class="cars-list">
          <button
            *ngFor="let car of getCarsToDisplay(); let i = index"
            type="button"
            class="car-card car-card-btn p-3 mb-2 border rounded-3 cursor-pointer car-card-hover w-100 text-start"
            (mousedown)="onCarCardClick($event, car)"
          >
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">
                  <span *ngIf="car.brand">{{ car.brand }}</span>
                  <span *ngIf="car.model"> {{ car.model }}</span>
                  <span *ngIf="car.year"> ({{ car.year }})</span>
                  <span *ngIf="!car.brand && !car.model">سيارة #{{ car.id }}</span>
                </div>
                <div class="text-muted small mt-1">
                  <i class="bi bi-map"></i> {{ car.plateNumber }}
                </div>
                <div class="text-muted small" *ngIf="car.color">
                  <i class="bi bi-palette"></i> {{ car.color }}
                </div>
                <div class="text-muted small" *ngIf="car.bodyType">
                  فئة: {{ getCarCategoryName(car.bodyType) }}
                </div>
                <div class="text-muted small" *ngIf="car.clientName">
                  العميل: {{ car.clientName }}
                </div>
              </div>
              <i class="bi bi-check-circle-fill text-success fs-4"></i>
            </div>
          </button>

          <div *ngIf="getCarsToDisplay().length === 0" class="text-center text-muted py-4">
            لا توجد سيارات متاحة
          </div>
        </div>
      </div>

      <div class="border-0 pt-0 d-flex justify-content-end gap-2 px-4 pb-4">
        <button type="button" class="btn btn-outline-secondary" (click)="closeCarSelectionModal()">
          إلغاء
        </button>
      </div>

    </div>
  </div>
</div>
