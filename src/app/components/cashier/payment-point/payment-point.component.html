<section class="contt" dir="rtl">
  <div class="page-wrap">

    <!-- Title -->
    <div class="page-title">
      <h2 class="title">
        <i class="bi bi-plus-square text-orange"></i>
        طلب جديد
      </h2>
      <p class="subtitle">اختر المنتجات وأدخل بيانات العميل لإصدار فاتورة</p>
    </div>

    <!-- Card 1: Customer -->
    <div class="card-box">
      <div class="card-head text-center d-flex align-items-center justify-content-start">
        <div class="card-head-title fs-4">
          <i class="bi bi-people text-orange"></i>
          بيانات العميل
        </div>
      </div>

      <div class="card-body">
        <div class="grid-2">
          <div class="field">
            <label class="form-label-custom">
              <i class="bi bi-person text-orange mx-1"></i> اسم العميل
            </label>
            <input class="form-control custom-input" type="text" [formControl]="orderForm.controls.fullName"
              placeholder="مثال: عصام الشوالي" />
          </div>

          <div class="field">
            <label class="form-label-custom">
              <i class="bi bi-telephone text-orange mx-1"></i> رقم الهاتف
            </label>
            <input class="form-control custom-input text-end" type="text" [formControl]="orderForm.controls.phoneNumber"
              placeholder="+966 5x xxx xxxx" />
          </div>
        </div>
      </div>
    </div>

    <!-- Card 2: Products -->
    <div class="card-box">
      <div class="card-head d-flex align-items-center justify-content-start">
        <div class="card-head-title fs-4">
          <i class="bi bi-bag text-orange"></i>
          اختر المنتجات
        </div>
      </div>

      <div class="card-body">
        <div class="services-grid">
          <div *ngFor="let p of products" class="service-card" [class.selected-active]="isProductSelected(p.id)"
            (click)="toggleProduct(p)">
            <div class="service-name">{{ p.name }}</div>
            <div class="service-price" *ngIf="p.price != null">{{ p.price }} ج.م</div>

            <div class="check-mark" *ngIf="isProductSelected(p.id)">
              <i class="bi bi-check-circle-fill"></i>
            </div>

            <!-- Qty controls -->
            <div class="qty-row" (click)="$event.stopPropagation()">
              <button type="button" class="qty-btn" (click)="$event.stopPropagation(); decreaseQty(p)">-</button>

              <input type="number" min="0" class="qty-input" [value]="getItem(p.id)?.qty || 0"
                (change)="setQty(p, $any($event.target).value)" />

              <button type="button" class="qty-btn" (click)="$event.stopPropagation(); increaseQty(p)">+</button>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="field mt-3">
          <label class="form-label-custom">
            <i class="bi bi-sticky text-orange mx-1"></i> ملاحظات
          </label>
          <textarea class="form-control custom-input" rows="2" [formControl]="orderForm.controls.notes"
            placeholder="ملاحظات اختيارية..."></textarea>
        </div>
      </div>
    </div>

    <!-- Bottom sticky summary bar -->
    <div class="bottom-bar ">
      <div class="bar-left">
        <button type="button" class="btn-primary" (click)="onSubmit()"
          [disabled]="orderForm.invalid || cart.length === 0 || isSubmitting">
          {{ isSubmitting ? 'جارٍ الحفظ...' : 'تأكيد' }}
        </button>

        <button type="button" class="btn-ghost"
          (click)="cart = []; orderForm.reset({fullName:'', phoneNumber:'', notes:''});">
          إلغاء
        </button>
      </div>

      <div class="bar-right">
        <div class="total-text">
          <span class="muted">الإجمالي:</span>
          <span class="total">{{ totalAmount | number:'1.2-2' }} ج.م</span>
        </div>
      </div>
    </div>

  </div>
</section>