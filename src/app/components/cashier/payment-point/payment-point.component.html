<section class="contt" dir="rtl">
  <div class="header-wrapper d-flex justify-content-between align-items-center mb-3">
    <div class="page-title mx-4 text-end">
      <h2 class="title fs-3">
        <i class="bi bi-plus-square text-orange"></i>
        طلب جديد
      </h2>
    </div>

    <div class="sub-tabs-container m-0">
      <div class="sub-tabs">
        <button class="tab-item" [class.active]="activeTab === 'new-order'" (click)="activeTab = 'new-order'">
          <i class="bi bi-cup-hot-fill me-2"></i>
          المشروبات
        </button>
        <button class="tab-item" [class.active]="activeTab === 'quick-booking'" (click)="activeTab = 'quick-booking'">
          <i class="bi bi-droplet-fill"></i> المغسلة
        </button>
      </div>
    </div>
  </div>

  <div class="page-wrap" *ngIf="activeTab === 'new-order'">
    <div class="page-wrap">

      <!-- Title -->


      <!-- Card 1: Customer -->
      <div class="card-box">
        <div class="card-head text-center d-flex align-items-center justify-content-start">
          <div class="card-head-title fs-4">
            <i class="bi bi-people-fill text-orange"></i>
            بيانات العميل
          </div>
        </div>

        <div class="card-body">
          <div class="grid-2">
            <div class="field">
              <label class="form-label-custom">
                <i class="bi bi-person text-orange mx-1"></i> اسم العميل
              </label>
              <input class="form-control custom-input" type="text" [formControl]="orderForm.controls.fullName"
                placeholder="مثال: عصام الشوالي" />
            </div>

            <div class="field">
              <label class="form-label-custom">
                <i class="bi bi-telephone text-orange mx-1"></i> رقم الهاتف
              </label>
              <input class="form-control custom-input text-end" type="text"
                [formControl]="orderForm.controls.phoneNumber" placeholder="+966 5x xxx xxxx"
                (keypress)="onlyNumbers($event)" inputmode="numeric" />
            </div>
          </div>
        </div>
      </div>

      <!-- Card 2: Products -->
      <div class="card-box">
        <div class="card-head d-flex align-items-center justify-content-start">
          <div class="card-head-title fs-4">
            <i class="bi bi-bag-fill text-orange"></i>
            اختر المنتجات
          </div>
        </div>

        <div class="card-body">
          <div class="services-grid">
            <div *ngFor="let p of products" class="service-card" [class.selected-active]="isProductSelected(p.id)"
              (click)="toggleProduct(p)">
              <div class="service-name">{{ p.name }}</div>
              <div class="service-price" *ngIf="p.price != null">{{ p.price }} ج.م</div>

              <div class="check-mark" *ngIf="isProductSelected(p.id)">
                <i class="bi bi-check-circle-fill"></i>
              </div>

              <!-- Qty controls -->
              <div class="qty-row" (click)="$event.stopPropagation()">
                <button type="button" class="qty-btn" (click)="$event.stopPropagation(); decreaseQty(p)">-</button>

                <input type="number" min="0" class="qty-input" [value]="getItem(p.id)?.qty || 0"
                  (change)="setQty(p, $any($event.target).value)" />

                <button type="button" class="qty-btn" (click)="$event.stopPropagation(); increaseQty(p)">+</button>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="field mt-3">
            <label class="form-label-custom">
              <i class="bi bi-sticky text-orange mx-1"></i> ملاحظات
            </label>
            <textarea class="form-control custom-input" rows="2" [formControl]="orderForm.controls.notes"
              placeholder="ملاحظات اختيارية..."></textarea>
          </div>
        </div>
      </div>

      <!-- Bottom sticky summary bar -->
      <div class="bottom-bar ">

        <div class="bar-right">
          <div class="total-text">
            <span class="muted">الإجمالي:</span>
            <span class="total">{{ totalAmount | number:'1.2-2' }} ج.م</span>
          </div>
        </div>

        <div class="bar-left">
          <button type="button" class="btn-ghost"
            (click)="cart = []; orderForm.reset({fullName:'', phoneNumber:'', notes:''});">
            إلغاء
          </button>

          <button type="button" class="btn-primary" (click)="onSubmit()"
            [disabled]="orderForm.invalid || cart.length === 0 || isSubmitting">
            {{ isSubmitting ? 'جارٍ الحفظ...' : 'تأكيد' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="page-wrap" *ngIf="activeTab === 'quick-booking'">

    <form [formGroup]="customerForm" (ngSubmit)="onSubmit()" class="reservation-form">
      <div class="form-section">
        <h3 class="form-section-title"><i class="bi bi-people-fill mx-1 fs-4"></i> بيانات العميل والسيارة</h3>
        <div class="row">
          <div class="form-group">
            <label><i class="bi bi-person mx-1"></i> اسم العميل </label>
            <input type="text" formControlName="name" placeholder="مثال: عصام الشوالي" />
          </div>
          <div class="form-group">
            <label><i class="bi bi-telephone mx-1"></i> رقم الهاتف 
              <span class="spinner-border spinner-border-sm text-primary ms-2" *ngIf="isLookingUpClient" role="status">
                <span class="visually-hidden">Loading...</span>
              </span>
            </label>
            <input type="text" formControlName="phone" placeholder="+966 5x xxx xxxx" class="text-end"
              (keypress)="onlyNumbers($event)" inputmode="numeric" />
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label><i class="bi bi-car-front mx-1"></i> نوع السيارة </label>
            <input type="text" formControlName="carType" placeholder="مثال: تويوتا كامري 2023" />
          </div>
          <div class="form-group">
            <label><i class="bi bi-map mx-1"></i> رقم اللوحة </label>
            <input type="text" formControlName="carNumber" placeholder="ب ص ج 1234" />
          </div>
          <div class="form-group mt-1">
            <label><i class="bi bi-car-front mx-1"></i> فئة السيارة </label>
            <select class="form-select custom-select" formControlName="carCategory">
              <option [ngValue]="null" disabled>اختر فئة السيارة</option>
              <option *ngFor="let cat of carCategories" [ngValue]="cat.id">
                {{ cat.nameAr }}
              </option>
            </select>

          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-group mb-3">
          <label><i class="bi bi-person-badge mx-1"></i> المشرف <span class="text-danger">*</span></label>
          <select class="form-select custom-select" [class.is-invalid]="showSupervisorError && !selectedSupervisorId"
            [(ngModel)]="selectedSupervisorId" (ngModelChange)="showSupervisorError = false" [ngModelOptions]="{standalone: true}">
            <option [ngValue]="null" disabled>-- اختر المشرف (اجباري) --</option>
            <option *ngFor="let sup of supervisors" [ngValue]="sup.id">{{ sup.name }}</option>
          </select>
          <div class="invalid-feedback d-block" *ngIf="showSupervisorError && !selectedSupervisorId">
            يجب اختيار المشرف
          </div>
        </div>

        <h3><i class="bi bi-info-circle-fill mx-1 fs-4"></i> تفاصيل الخدمة</h3>
        <!-- <div class="row">
          <div class="form-group col-md-8">
            <label><i class="bi bi-calendar-date mx-1"></i> تاريخ الحجز </label>
            <input type="date" formControlName="appointmentDate" (change)="loadAvailableSlots()" />
          </div>
          <div class="form-group col-md-4">
            <label><i class="bi bi-clock mx-1"></i> الوقت

              <small class="text-muted d-inline-block mb-2 mx-1" *ngIf="isSlotsLoading">
                جاري تحميل المواعيد...
              </small>

            </label>


            <select class="form-select" [(ngModel)]="selectedSlotHour" [ngModelOptions]="{ standalone: true }"
              [disabled]="availableSlots.length === 0">
              <option [ngValue]="null" disabled selected>اختر وقت</option>

              <option *ngFor="let slot of availableSlots" [ngValue]="slot.hour" [disabled]="slot.available === 0">
                {{ slot.hour }} - (متاح: {{ slot.available }})
              </option>
            </select>


            <small class="text-danger d-block mt-2" *ngIf="
                !isSlotsLoading &&
                selectedServices.length > 0 &&
                customerForm.value.appointmentDate &&
                (!availableSlots || availableSlots.length === 0)
              ">
              لا توجد مواعيد متاحة لهذا اليوم.
            </small>
          </div>

        </div> -->

        <input type="hidden" formControlName="appointmentDate" />

        <div class="form-group">
          <label class="mb-3"><i class="bi bi-wrench mx-2"></i> اختر الخدمة
          </label>
          <div class="services-container">
            <div class="service-card" *ngFor="let service of services" [class.selected]="isServiceSelected(service)">
              <input type="checkbox" [id]="'service-' + service.id" (change)="toggleService(service, $event)"
                [checked]="isServiceSelected(service)" />
              <label [for]="'service-' + service.id" class="service-content">
                <span class="service-name">{{ service.name }}</span>
                <span class="service-price">{{ service.price }} ج.م</span>
                <div class="check-icon" *ngIf="isServiceSelected(service)">
                  <i class="bi bi-check-circle-fill"></i>
                </div>
              </label>


              <div class="mt-2" *ngIf="isServiceSelected(service)">
                <select class="form-select form-select-sm" [(ngModel)]="serviceEmployeeMap[service.id]"
                  [ngModelOptions]="{ standalone: true }">
                  <option [ngValue]="null" disabled>اختر العامل</option>
                  <option *ngFor="let emp of (serviceEmployees[service.id] || [])" [ngValue]="emp.id">
                    {{ emp.name }}
                  </option>
                </select>

                <small class="text-muted d-block mt-1" *ngIf="(serviceEmployees[service.id] || []).length === 0 && !isEmployeesLoading">
                  لا يوجد عمال متاحين لهذه الخدمة
                </small>
                <small class="text-muted d-block mt-1" *ngIf="isEmployeesLoading">
                  جاري تحميل العمال...
                </small>
              </div>




            </div>
          </div>


          <div class="card-head d-flex align-items-center justify-content-start">
            <div class="card-head-title fs-4">
              <i class="bi bi-bag-fill text-orange"></i>
              اختر المنتجات
            </div>
          </div>


          <div class="services-grid mt-4">
            <div *ngFor="let p of products" class="service-card" [class.selected-active]="isProductSelected(p.id)"
              (click)="toggleProduct(p)">
              <div class="service-name">{{ p.name }}</div>
              <div class="service-price" *ngIf="p.price != null">{{ p.price }} ج.م</div>

              <div class="check-mark" *ngIf="isProductSelected(p.id)">
                <i class="bi bi-check-circle-fill"></i>
              </div>

              <!-- Qty controls -->
              <div class="qty-row" (click)="$event.stopPropagation()">
                <button type="button" class="qty-btn" (click)="$event.stopPropagation(); decreaseQty(p)">-</button>

                <input type="number" min="0" class="qty-input" [value]="getItem(p.id)?.qty || 0"
                  (change)="setQty(p, $any($event.target).value)" />

                <button type="button" class="qty-btn" (click)="$event.stopPropagation(); increaseQty(p)">+</button>
              </div>
            </div>
          </div>
        </div>
      </div>



      <div class="form-footer">
        <div class="total-price">
          <span>الإجمالي المتوقع: </span>
          <strong>{{ totalPrice }} ج.م</strong>
        </div>
        <div class="actions">
          <button type="button" class="btn-cancel" (click)="customerForm.reset()">
            إلغاء
          </button>
          <button type="submit" class="btn-save">تأكيد الحجز</button>
        </div>
      </div>
    </form>

  </div>
</section>













<div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true" dir="rtl">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
    <div class="modal-content border-0 shadow-lg">

      <div class="text-end p-2 no-print">
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4 forto-invoice-container" *ngIf="invoiceData">

        <div class="text-center mb-2">
          <img src="../../../../assets/imeg/logo forto.png" class="brand-logo  mb-1" style="max-width: 150px;">

          <h5 class="fw-bold m-0">فاتورة POS</h5>
          <div class="small text-muted">#{{ invoiceData.invoiceNumber }}</div>
        </div>

        <hr class="my-2" style="border-top: 1px dashed #000;">

        <div class="mb-3 fw-bold" style="font-size: 12px;">
          <div><strong>العميل:</strong> {{ invoiceData.clientName || invoiceData.customerName || customerFormData?.name || '-' }}</div>
          <div><strong>الهاتف:</strong> {{ invoiceData.clientNumber || invoiceData.phoneNumber || invoiceData.phone || customerFormData?.phone || '-' }}</div>
          <div><strong>التاريخ:</strong> {{ invoiceData.paidAt | date:'dd/MM/yyyy - hh:mm a' }}</div>
        </div>

        <table class="table table-sm mb-2" style="font-size: 12px;">
          <thead class="border-bottom">
            <tr>
              <th class="text-end">البند</th>
              <th class="text-center">الكمية</th>
              <th class="text-center">السعر</th>
              <th class="text-center">الإجمالي</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of invoiceData.lines">
              <td class="text-end">{{ it.description }}</td>
              <td class="text-center">{{ it.qty }}</td>
              <td class="text-center fw-bold">{{ it.unitPrice | number:'1.2-2' }}</td>
              <td class="text-center fw-bold">{{ it.total | number:'1.2-2' }}</td>
            </tr>
          </tbody>
        </table>

        <hr class="my-2" style="border-top: 1px dashed #000;">

        <div style="font-size: 13px; font-weight: bold;">
          <div class="d-flex justify-content-between">
            <span>المجموع:</span>
            <span>{{ invoiceData.subTotal | number:'1.2-2' }} ج.م</span>
          </div>

          <div class="d-flex justify-content-between">
            <span>الضريبة (14%):</span>
            <span>{{ invoiceVat | number:'1.2-2' }} ج.م</span>
          </div>

          <div class="d-flex justify-content-between mt-1" style="font-size: 15px;">
            <span>الإجمالي:</span>
            <span class="text-orange">{{ invoiceData.total | number:'1.2-2' }} ج.م</span>
          </div>
        </div>

        <div class="text-center mt-3 small text-muted">
          شكراً لزيارتكم فورتو
        </div>
      </div>

      <div class="modal-footer no-print justify-content-center bg-light">
        <button class="btn btn-warning text-white fw-bold px-5 rounded-pill shadow-sm" (click)="printInvoice()">
          <i class="bi bi-printer me-2"></i> طباعة
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Car Selection Modal -->
<div class="modal fade" id="carSelectionModal" tabindex="-1" aria-hidden="true" dir="rtl" *ngIf="showCarSelectionModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">اختر السيارة</h5>
        <button type="button" class="btn-close ms-0 me-auto" (click)="closeCarSelectionModal()"></button>
      </div>

      <div class="modal-body p-4">
        <div *ngIf="selectedClient">
          <div class="alert alert-info mb-3">
            <strong>العميل:</strong> {{ selectedClient.fullName }}<br>
            <strong>الهاتف:</strong> {{ selectedClient.phoneNumber }}
          </div>
        </div>

        <div *ngIf="foundClients.length > 1 && !selectedClient" class="alert alert-warning mb-3">
          تم العثور على {{ foundClients.length }} عملاء بهذا الرقم. اختر السيارة:
        </div>

        <div class="cars-list">
          <div 
            *ngFor="let car of getCarsToDisplay(); let i = index" 
            class="car-card p-3 mb-2 border rounded-3 car-card-hover"
            (click)="selectCar(car)">
            
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">
                  <span *ngIf="car.brand">{{ car.brand }}</span>
                  <span *ngIf="car.model"> {{ car.model }}</span>
                  <span *ngIf="car.year"> ({{ car.year }})</span>
                  <span *ngIf="!car.brand && !car.model">سيارة #{{ car.id }}</span>
                </div>
                <div class="text-muted small mt-1">
                  <i class="bi bi-map"></i> {{ car.plateNumber }}
                </div>
                <div class="text-muted small" *ngIf="car.color">
                  <i class="bi bi-palette"></i> {{ car.color }}
                </div>
                <div class="text-muted small" *ngIf="car.bodyType">
                  فئة: {{ getCarCategoryName(car.bodyType) }}
                </div>
                <div class="text-muted small" *ngIf="car.clientName">
                  العميل: {{ car.clientName }}
                </div>
              </div>
              <i class="bi bi-check-circle-fill text-success fs-4"></i>
            </div>
          </div>

          <div *ngIf="getCarsToDisplay().length === 0" class="text-center text-muted py-4">
            لا توجد سيارات متاحة
          </div>
        </div>
      </div>

      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" (click)="closeCarSelectionModal()">
          إلغاء
        </button>
      </div>

    </div>
  </div>
</div>